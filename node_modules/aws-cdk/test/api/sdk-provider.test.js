"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const cxapi = require("@aws-cdk/cx-api");
const AWS = require("aws-sdk");
const SDKMock = require("aws-sdk-mock");
const uuid = require("uuid");
const lib_1 = require("../../lib");
const aws_auth_1 = require("../../lib/api/aws-auth");
const logging = require("../../lib/logging");
const bockfs = require("../bockfs");
const util_1 = require("../util");
// Mock promptly prompt to test MFA support
jest.mock('promptly', () => ({
    prompt: jest.fn().mockRejectedValue(new Error('test')),
}));
SDKMock.setSDKInstance(AWS);
const defaultCredOptions = {
    ec2creds: false,
    containerCreds: false,
};
// Account cache buster
let uid;
let pluginQueried = false;
let defaultEnv;
beforeEach(() => {
    uid = `(${uuid.v4()})`;
    logging.setLogLevel(2 /* TRACE */);
    SDKMock.mock('STS', 'getCallerIdentity', (cb) => {
        return cb(null, {
            Account: `${uid}the_account_#`,
            UserId: 'you!',
            Arn: 'arn:aws-here:iam::12345:role/test',
        });
    });
    lib_1.PluginHost.instance.credentialProviderSources.splice(0);
    lib_1.PluginHost.instance.credentialProviderSources.push({
        isAvailable() { return Promise.resolve(true); },
        canProvideCredentials(account) { return Promise.resolve(account === `${uid}plugin_account_#`); },
        getProvider() {
            pluginQueried = true;
            return Promise.resolve(new AWS.Credentials({
                accessKeyId: `${uid}plugin_key`,
                secretAccessKey: 'plugin_secret',
                sessionToken: 'plugin_token',
            }));
        },
        name: 'test plugin',
    });
    defaultEnv = cxapi.EnvironmentUtils.make(`${uid}the_account_#`, 'def');
    // Scrub some environment variables that might be set if we're running on CodeBuild which will interfere with the tests.
    delete process.env.AWS_PROFILE;
    delete process.env.AWS_REGION;
    delete process.env.AWS_DEFAULT_REGION;
    delete process.env.AWS_ACCESS_KEY_ID;
    delete process.env.AWS_SECRET_ACCESS_KEY;
    delete process.env.AWS_SESSION_TOKEN;
});
afterEach(() => {
    logging.setLogLevel(0 /* DEFAULT */);
    SDKMock.restore();
    bockfs.restore();
});
describe('with default config files', () => {
    beforeEach(() => {
        bockfs({
            '/home/me/.bxt/credentials': dedent(`
        [default]
        aws_access_key_id=${uid}access
        aws_secret_access_key=secret

        [foo]
        aws_access_key_id=${uid}fooccess
        aws_secret_access_key=secret

        [assumer]
        aws_access_key_id=${uid}assumer
        aws_secret_access_key=secret

        [mfa]
        aws_access_key_id=${uid}mfaccess
        aws_secret_access_key=secret
      `),
            '/home/me/.bxt/config': dedent(`
        [default]
        region=eu-bla-5

        [profile foo]
        region=eu-west-1

        [profile boo]
        aws_access_key_id=${uid}booccess
        aws_secret_access_key=boocret
        # No region here

        [profile assumable]
        role_arn=arn:aws:iam::12356789012:role/Assumable
        source_profile=assumer

        [profile assumer]
        region=us-east-2

        [profile mfa]
        region=eu-west-1

        [profile mfa-role]
        source_profile=mfa
        role_arn=arn:aws:iam::account:role/role
        mfa_serial=arn:aws:iam::account:mfa/user
      `),
        });
        // Set environment variables that we want
        process.env.AWS_CONFIG_FILE = bockfs.path('/home/me/.bxt/config');
        process.env.AWS_SHARED_CREDENTIALS_FILE = bockfs.path('/home/me/.bxt/credentials');
    });
    describe('CLI compatible credentials loading', () => {
        test('default config credentials', async () => {
            // WHEN
            const provider = await aws_auth_1.SdkProvider.withAwsCliCompatibleDefaults({ ...defaultCredOptions });
            // THEN
            expect(provider.defaultRegion).toEqual('eu-bla-5');
            await expect(provider.defaultAccount()).resolves.toEqual({ accountId: `${uid}the_account_#`, partition: 'aws-here' });
            const sdk = await provider.forEnvironment({ ...defaultEnv, region: 'rgn' }, aws_auth_1.Mode.ForReading);
            expect(sdkConfig(sdk).credentials.accessKeyId).toEqual(`${uid}access`);
            expect(sdkConfig(sdk).region).toEqual('rgn');
        });
        test('unknown account and region uses current', async () => {
            // WHEN
            const provider = await aws_auth_1.SdkProvider.withAwsCliCompatibleDefaults({ ...defaultCredOptions });
            // THEN
            const sdk = await provider.forEnvironment(cxapi.EnvironmentUtils.make(cxapi.UNKNOWN_ACCOUNT, cxapi.UNKNOWN_REGION), aws_auth_1.Mode.ForReading);
            expect(sdkConfig(sdk).credentials.accessKeyId).toEqual(`${uid}access`);
            expect(sdkConfig(sdk).region).toEqual('eu-bla-5');
        });
        test('mixed profile credentials', async () => {
            // WHEN
            const provider = await aws_auth_1.SdkProvider.withAwsCliCompatibleDefaults({ ...defaultCredOptions, profile: 'foo' });
            // THEN
            expect(provider.defaultRegion).toEqual('eu-west-1');
            await expect(provider.defaultAccount()).resolves.toEqual({ accountId: `${uid}the_account_#`, partition: 'aws-here' });
            const sdk = await provider.forEnvironment(defaultEnv, aws_auth_1.Mode.ForReading);
            expect(sdkConfig(sdk).credentials.accessKeyId).toEqual(`${uid}fooccess`);
        });
        test('pure config credentials', async () => {
            // WHEN
            const provider = await aws_auth_1.SdkProvider.withAwsCliCompatibleDefaults({ ...defaultCredOptions, profile: 'boo' });
            // THEN
            expect(provider.defaultRegion).toEqual('eu-bla-5'); // Fall back to default config
            await expect(provider.defaultAccount()).resolves.toEqual({ accountId: `${uid}the_account_#`, partition: 'aws-here' });
            const sdk = await provider.forEnvironment(defaultEnv, aws_auth_1.Mode.ForReading);
            expect(sdkConfig(sdk).credentials.accessKeyId).toEqual(`${uid}booccess`);
        });
        test('mfa_serial in profile will ask user for token', async () => {
            // WHEN
            const provider = await aws_auth_1.SdkProvider.withAwsCliCompatibleDefaults({ ...defaultCredOptions, profile: 'mfa-role' });
            // THEN
            try {
                await provider.withAssumedRole('arn:aws:iam::account:role/role', undefined, undefined);
            }
            catch (e) {
                // Mock response was set to fail with message test to make sure we don't call STS
                expect(e.message).toEqual('Error fetching MFA token: test');
            }
        });
        test('different account throws', async () => {
            const provider = await aws_auth_1.SdkProvider.withAwsCliCompatibleDefaults({ ...defaultCredOptions, profile: 'boo' });
            await expect(provider.forEnvironment({ ...defaultEnv, account: `${uid}some_account_#` }, aws_auth_1.Mode.ForReading)).rejects.toThrow('Need to perform AWS calls');
        });
        test('even when using a profile to assume another profile, STS calls goes through the proxy', async () => {
            // Messy mocking
            let called = false;
            jest.mock('proxy-agent', () => {
                // eslint-disable-next-line @typescript-eslint/no-require-imports
                class FakeAgent extends require('https').Agent {
                    addRequest(_, __) {
                        // FIXME: this error takes 6 seconds to be completely handled. It
                        // might be retries in the SDK somewhere, or something about the Node
                        // event loop. I've spent an hour trying to figure it out and I can't,
                        // and I gave up. We'll just have to live with this until someone gets
                        // inspired.
                        const error = new Error('ABORTED BY TEST');
                        error.code = 'RequestAbortedError';
                        error.retryable = false;
                        called = true;
                        throw error;
                    }
                }
                return FakeAgent;
            });
            // WHEN
            const provider = await aws_auth_1.SdkProvider.withAwsCliCompatibleDefaults({
                ...defaultCredOptions,
                profile: 'assumable',
                httpOptions: {
                    proxyAddress: 'http://DOESNTMATTER/',
                },
            });
            await provider.defaultAccount();
            // THEN -- the fake proxy agent got called, we don't care about the result
            expect(called).toEqual(true);
        });
        test('error we get from assuming a role is useful', async () => {
            // GIVEN
            // Because of the way ChainableTemporaryCredentials gets its STS client, it's not mockable
            // using 'mock-aws-sdk'. So instead, we have to mess around with its internals.
            function makeAssumeRoleFail(s) {
                s.credentials.service.assumeRole = jest.fn().mockImplementation((_request, cb) => {
                    cb(new Error('Nope!'));
                });
            }
            const provider = await aws_auth_1.SdkProvider.withAwsCliCompatibleDefaults({
                ...defaultCredOptions,
                httpOptions: {
                    proxyAddress: 'http://localhost:8080/',
                },
            });
            // WHEN
            const sdk = await provider.withAssumedRole('bla.role.arn', undefined, undefined);
            makeAssumeRoleFail(sdk);
            // THEN - error message contains both a helpful hint and the underlying AssumeRole message
            await expect(sdk.s3().listBuckets().promise()).rejects.toThrow('did you bootstrap');
            await expect(sdk.s3().listBuckets().promise()).rejects.toThrow('Nope!');
        });
    });
    describe('Plugins', () => {
        test('does not use plugins if current credentials are for expected account', async () => {
            const provider = await aws_auth_1.SdkProvider.withAwsCliCompatibleDefaults({ ...defaultCredOptions });
            await provider.forEnvironment(defaultEnv, aws_auth_1.Mode.ForReading);
            expect(pluginQueried).toEqual(false);
        });
        test('uses plugin for other account', async () => {
            const provider = await aws_auth_1.SdkProvider.withAwsCliCompatibleDefaults({ ...defaultCredOptions });
            await provider.forEnvironment({ ...defaultEnv, account: `${uid}plugin_account_#` }, aws_auth_1.Mode.ForReading);
            expect(pluginQueried).toEqual(true);
        });
    });
});
test('can assume role without a [default] profile', async () => {
    // GIVEN
    bockfs({
        '/home/me/.bxt/credentials': dedent(`
      [assumer]
      aws_access_key_id=${uid}assumer
      aws_secret_access_key=secret

      [assumable]
      role_arn=arn:aws:iam::12356789012:role/Assumable
      source_profile=assumer
    `),
        '/home/me/.bxt/config': dedent(`
      [profile assumable]
      region=eu-bla-5
    `),
    });
    SDKMock.mock('STS', 'assumeRole', (_request, cb) => {
        return cb(null, {
            Credentials: {
                AccessKeyId: `${uid}access`,
                Expiration: new Date(Date.now() + 10000),
                SecretAccessKey: 'b',
                SessionToken: 'c',
            },
        });
    });
    // Set environment variables that we want
    process.env.AWS_CONFIG_FILE = bockfs.path('/home/me/.bxt/config');
    process.env.AWS_SHARED_CREDENTIALS_FILE = bockfs.path('/home/me/.bxt/credentials');
    // WHEN
    const provider = await aws_auth_1.SdkProvider.withAwsCliCompatibleDefaults({
        ...defaultCredOptions,
        profile: 'assumable',
        httpOptions: {
            proxyAddress: 'http://DOESNTMATTER/',
        },
    });
    const account = await provider.defaultAccount();
    // THEN
    expect(account === null || account === void 0 ? void 0 : account.accountId).toEqual(`${uid}the_account_#`);
});
test('can assume role with ecs credentials', async () => {
    return util_1.withMocked(AWS.ECSCredentials.prototype, 'needsRefresh', async (needsRefresh) => {
        // GIVEN
        bockfs({
            '/home/me/.bxt/credentials': dedent(`
    `),
            '/home/me/.bxt/config': dedent(`
      [profile ecs]
      role_arn=arn:aws:iam::12356789012:role/Assumable
      credential_source = EcsContainer
    `),
        });
        // Set environment variables that we want
        process.env.AWS_CONFIG_FILE = bockfs.path('/home/me/.bxt/config');
        process.env.AWS_SHARED_CREDENTIALS_FILE = bockfs.path('/home/me/.bxt/credentials');
        // WHEN
        const provider = await aws_auth_1.SdkProvider.withAwsCliCompatibleDefaults({
            ...defaultCredOptions,
            profile: 'ecs',
            httpOptions: {
                proxyAddress: 'http://DOESNTMATTER/',
            },
        });
        await provider.defaultAccount();
        // THEN
        // expect(account?.accountId).toEqual(`${uid}the_account_#`);
        expect(needsRefresh).toHaveBeenCalled();
    });
});
test('can assume role with ec2 credentials', async () => {
    return util_1.withMocked(AWS.EC2MetadataCredentials.prototype, 'needsRefresh', async (needsRefresh) => {
        // GIVEN
        bockfs({
            '/home/me/.bxt/credentials': dedent(`
    `),
            '/home/me/.bxt/config': dedent(`
      [profile ecs]
      role_arn=arn:aws:iam::12356789012:role/Assumable
      credential_source = Ec2InstanceMetadata
    `),
        });
        // Set environment variables that we want
        process.env.AWS_CONFIG_FILE = bockfs.path('/home/me/.bxt/config');
        process.env.AWS_SHARED_CREDENTIALS_FILE = bockfs.path('/home/me/.bxt/credentials');
        // WHEN
        const provider = await aws_auth_1.SdkProvider.withAwsCliCompatibleDefaults({
            ...defaultCredOptions,
            profile: 'ecs',
            httpOptions: {
                proxyAddress: 'http://DOESNTMATTER/',
            },
        });
        await provider.defaultAccount();
        // THEN
        // expect(account?.accountId).toEqual(`${uid}the_account_#`);
        expect(needsRefresh).toHaveBeenCalled();
    });
});
test('can assume role with env credentials', async () => {
    return util_1.withMocked(AWS.EnvironmentCredentials.prototype, 'needsRefresh', async (needsRefresh) => {
        // GIVEN
        bockfs({
            '/home/me/.bxt/credentials': dedent(`
    `),
            '/home/me/.bxt/config': dedent(`
      [profile ecs]
      role_arn=arn:aws:iam::12356789012:role/Assumable
      credential_source = Environment
    `),
        });
        // Set environment variables that we want
        process.env.AWS_CONFIG_FILE = bockfs.path('/home/me/.bxt/config');
        process.env.AWS_SHARED_CREDENTIALS_FILE = bockfs.path('/home/me/.bxt/credentials');
        // WHEN
        const provider = await aws_auth_1.SdkProvider.withAwsCliCompatibleDefaults({
            ...defaultCredOptions,
            profile: 'ecs',
            httpOptions: {
                proxyAddress: 'http://DOESNTMATTER/',
            },
        });
        await provider.defaultAccount();
        // THEN
        // expect(account?.accountId).toEqual(`${uid}the_account_#`);
        expect(needsRefresh).toHaveBeenCalled();
    });
});
test('assume fails with unsupported credential_source', async () => {
    // GIVEN
    bockfs({
        '/home/me/.bxt/config': dedent(`
      [profile assumable]
      role_arn=arn:aws:iam::12356789012:role/Assumable
      credential_source = unsupported
    `),
    });
    SDKMock.mock('STS', 'assumeRole', (_request, cb) => {
        return cb(null, {
            Credentials: {
                AccessKeyId: `${uid}access`,
                Expiration: new Date(Date.now() + 10000),
                SecretAccessKey: 'b',
                SessionToken: 'c',
            },
        });
    });
    // Set environment variables that we want
    process.env.AWS_CONFIG_FILE = bockfs.path('/home/me/.bxt/config');
    process.env.AWS_SHARED_CREDENTIALS_FILE = bockfs.path('/home/me/.bxt/credentials');
    // WHEN
    const provider = await aws_auth_1.SdkProvider.withAwsCliCompatibleDefaults({
        ...defaultCredOptions,
        profile: 'assumable',
        httpOptions: {
            proxyAddress: 'http://DOESNTMATTER/',
        },
    });
    const account = await provider.defaultAccount();
    // THEN
    expect(account === null || account === void 0 ? void 0 : account.accountId).toEqual(undefined);
});
/**
 * Strip shared whitespace from the start of lines
 */
function dedent(x) {
    const lines = x.split('\n');
    while (lines.length > 0 && lines[0].trim() === '') {
        lines.shift();
    }
    while (lines.length > 0 && lines[lines.length - 1].trim() === '') {
        lines.pop();
    }
    const wsRe = /^\s*/;
    const lineParts = x.split('\n').map(s => {
        const ws = wsRe.exec(s)[0];
        return [ws, s.substr(ws.length)];
    });
    if (lineParts.length === 0) {
        return '';
    } // Reduce won't work well in this case
    // Calculate common whitespace only for non-empty lines
    const sharedWs = lineParts.reduce((commonWs, [ws, text]) => text !== '' ? commonPrefix(commonWs, ws) : commonWs, lineParts[0][0]);
    return lines.map(s => s.substr(sharedWs.length)).join('\n');
}
/**
 * Use object hackery to get the credentials out of the SDK object
 */
function sdkConfig(sdk) {
    return sdk.config;
}
function commonPrefix(a, b) {
    const N = Math.min(a.length, b.length);
    for (let i = 0; i < N; i++) {
        if (a[i] !== b[i]) {
            return a.substring(0, i);
        }
    }
    return a.substr(N);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2RrLXByb3ZpZGVyLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzZGstcHJvdmlkZXIudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHlDQUF5QztBQUN6QywrQkFBK0I7QUFDL0Isd0NBQXdDO0FBRXhDLDZCQUE2QjtBQUM3QixtQ0FBdUM7QUFDdkMscURBQWlFO0FBQ2pFLDZDQUE2QztBQUM3QyxvQ0FBb0M7QUFDcEMsa0NBQXFDO0FBRXJDLDJDQUEyQztBQUMzQyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQzNCLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsaUJBQWlCLENBQUMsSUFBSSxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7Q0FDdkQsQ0FBQyxDQUFDLENBQUM7QUFFSixPQUFPLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBSTVCLE1BQU0sa0JBQWtCLEdBQUc7SUFDekIsUUFBUSxFQUFFLEtBQUs7SUFDZixjQUFjLEVBQUUsS0FBSztDQUN0QixDQUFDO0FBRUYsdUJBQXVCO0FBQ3ZCLElBQUksR0FBVyxDQUFDO0FBQ2hCLElBQUksYUFBYSxHQUFHLEtBQUssQ0FBQztBQUMxQixJQUFJLFVBQTZCLENBQUM7QUFFbEMsVUFBVSxDQUFDLEdBQUcsRUFBRTtJQUNkLEdBQUcsR0FBRyxJQUFJLElBQUksQ0FBQyxFQUFFLEVBQUUsR0FBRyxDQUFDO0lBRXZCLE9BQU8sQ0FBQyxXQUFXLGVBQXdCLENBQUM7SUFFNUMsT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsbUJBQW1CLEVBQUUsQ0FBQyxFQUFrRCxFQUFFLEVBQUU7UUFDOUYsT0FBTyxFQUFFLENBQUMsSUFBSSxFQUFFO1lBQ2QsT0FBTyxFQUFFLEdBQUcsR0FBRyxlQUFlO1lBQzlCLE1BQU0sRUFBRSxNQUFNO1lBQ2QsR0FBRyxFQUFFLG1DQUFtQztTQUN6QyxDQUFD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RSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsSUFBSSxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLFFBQVEsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzFJLE9BQU8sS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQzlELENBQUM7QUFFRDs7R0FFRztBQUNILFNBQVMsU0FBUyxDQUFDLEdBQVM7SUFDMUIsT0FBUSxHQUFXLENBQUMsTUFBTSxDQUFDO0FBQzdCLENBQUM7QUFFRCxTQUFTLFlBQVksQ0FBQyxDQUFTLEVBQUUsQ0FBUztJQUN4QyxNQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3ZDLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7UUFDMUIsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFO1lBQUUsT0FBTyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztTQUFFO0tBQ2pEO0lBQ0QsT0FBTyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3JCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBjeGFwaSBmcm9tICdAYXdzLWNkay9jeC1hcGknO1xuaW1wb3J0ICogYXMgQVdTIGZyb20gJ2F3cy1zZGsnO1xuaW1wb3J0ICogYXMgU0RLTW9jayBmcm9tICdhd3Mtc2RrLW1vY2snO1xuaW1wb3J0IHsgQ29uZmlndXJhdGlvbk9wdGlvbnMgfSBmcm9tICdhd3Mtc2RrL2xpYi9jb25maWcnO1xuaW1wb3J0ICogYXMgdXVpZCBmcm9tICd1dWlkJztcbmltcG9ydCB7IFBsdWdpbkhvc3QgfSBmcm9tICcuLi8uLi9saWInO1xuaW1wb3J0IHsgSVNESywgTW9kZSwgU2RrUHJvdmlkZXIgfSBmcm9tICcuLi8uLi9saWIvYXBpL2F3cy1hdXRoJztcbmltcG9ydCAqIGFzIGxvZ2dpbmcgZnJvbSAnLi4vLi4vbGliL2xvZ2dpbmcnO1xuaW1wb3J0ICogYXMgYm9ja2ZzIGZyb20gJy4uL2JvY2tmcyc7XG5pbXBvcnQgeyB3aXRoTW9ja2VkIH0gZnJvbSAnLi4vdXRpbCc7XG5cbi8vIE1vY2sgcHJvbXB0bHkgcHJvbXB0IHRvIHRlc3QgTUZBIHN1cHBvcnRcbmplc3QubW9jaygncHJvbXB0bHknLCAoKSA9PiAoe1xuICBwcm9tcHQ6IGplc3QuZm4oKS5tb2NrUmVqZWN0ZWRWYWx1ZShuZXcgRXJyb3IoJ3Rlc3QnKSksXG59KSk7XG5cblNES01vY2suc2V0U0RLSW5zdGFuY2UoQVdTKTtcblxudHlwZSBBd3NDYWxsYmFjazxUPiA9IChlcnI6IEVycm9yIHwgbnVsbCwgdmFsOiBUKSA9PiB2b2lkO1xuXG5jb25zdCBkZWZhdWx0Q3JlZE9wdGlvbnMgPSB7XG4gIGVjMmNyZWRzOiBmYWxzZSxcbiAgY29udGFpbmVyQ3JlZHM6IGZhbHNlLFxufTtcblxuLy8gQWNjb3VudCBjYWNoZSBidXN0ZXJcbmxldCB1aWQ6IHN0cmluZztcbmxldCBwbHVnaW5RdWVyaWVkID0gZmFsc2U7XG5sZXQgZGVmYXVsdEVudjogY3hhcGkuRW52aXJvbm1lbnQ7XG5cbmJlZm9yZUVhY2goKCkgPT4ge1xuICB1aWQgPSBgKCR7dXVpZC52NCgpfSlgO1xuXG4gIGxvZ2dpbmcuc2V0TG9nTGV2ZWwobG9nZ2luZy5Mb2dMZXZlbC5UUkFDRSk7XG5cbiAgU0RLTW9jay5tb2NrKCdTVFMnLCAnZ2V0Q2FsbGVySWRlbnRpdHknLCAoY2I6IEF3c0NhbGxiYWNrPEFXUy5TVFMuR2V0Q2FsbGVySWRlbnRpdHlSZXNwb25zZT4pID0+IHtcbiAgICByZXR1cm4gY2IobnVsbCwge1xuICAgICAgQWNjb3VudDogYCR7dWlkfXRoZV9hY2NvdW50XyNgLFxuICAgICAgVXNlcklkOiAneW91IScsXG4gICAgICBBcm46ICdhcm46YXdzLWhlcmU6aWFtOjoxMjM0NTpyb2xlL3Rlc3QnLFxuICAgIH0pO1xuICB9KTtcblxuICBQbHVnaW5Ib3N0Lmluc3RhbmNlLmNyZWRlbnRpYWxQcm92aWRlclNvdXJjZXMuc3BsaWNlKDApO1xuICBQbHVnaW5Ib3N0Lmluc3RhbmNlLmNyZWRlbnRpYWxQcm92aWRlclNvdXJjZXMucHVzaCh7XG4gICAgaXNBdmFpbGFibGUoKSB7IHJldHVybiBQcm9taXNlLnJlc29sdmUodHJ1ZSk7IH0sXG4gICAgY2FuUHJvdmlkZUNyZWRlbnRpYWxzKGFjY291bnQpIHsgcmV0dXJuIFByb21pc2UucmVzb2x2ZShhY2NvdW50ID09PSBgJHt1aWR9cGx1Z2luX2FjY291bnRfI2ApOyB9LFxuICAgIGdldFByb3ZpZGVyKCkge1xuICAgICAgcGx1Z2luUXVlcmllZCA9IHRydWU7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKG5ldyBBV1MuQ3JlZGVudGlhbHMoe1xuICAgICAgICBhY2Nlc3NLZXlJZDogYCR7dWlkfXBsdWdpbl9rZXlgLFxuICAgICAgICBzZWNyZXRBY2Nlc3NLZXk6ICdwbHVnaW5fc2VjcmV0JyxcbiAgICAgICAgc2Vzc2lvblRva2VuOiAncGx1Z2luX3Rva2VuJyxcbiAgICAgIH0pKTtcbiAgICB9LFxuICAgIG5hbWU6ICd0ZXN0IHBsdWdpbicsXG4gIH0pO1xuXG4gIGRlZmF1bHRFbnYgPSBjeGFwaS5FbnZpcm9ubWVudFV0aWxzLm1ha2UoYCR7dWlkfXRoZV9hY2NvdW50XyNgLCAnZGVmJyk7XG5cbiAgLy8gU2NydWIgc29tZSBlbnZpcm9ubWVudCB2YXJpYWJsZXMgdGhhdCBtaWdodCBiZSBzZXQgaWYgd2UncmUgcnVubmluZyBvbiBDb2RlQnVpbGQgd2hpY2ggd2lsbCBpbnRlcmZlcmUgd2l0aCB0aGUgdGVzdHMuXG4gIGRlbGV0ZSBwcm9jZXNzLmVudi5BV1NfUFJPRklMRTtcbiAgZGVsZXRlIHByb2Nlc3MuZW52LkFXU19SRUdJT047XG4gIGRlbGV0ZSBwcm9jZXNzLmVudi5BV1NfREVGQVVMVF9SRUdJT047XG4gIGRlbGV0ZSBwcm9jZXNzLmVudi5BV1NfQUNDRVNTX0tFWV9JRDtcbiAgZGVsZXRlIHByb2Nlc3MuZW52LkFXU19TRUNSRVRfQUNDRVNTX0tFWTtcbiAgZGVsZXRlIHByb2Nlc3MuZW52LkFXU19TRVNTSU9OX1RPS0VOO1xufSk7XG5cbmFmdGVyRWFjaCgoKSA9PiB7XG4gIGxvZ2dpbmcuc2V0TG9nTGV2ZWwobG9nZ2luZy5Mb2dMZXZlbC5ERUZBVUxUKTtcblxuICBTREtNb2NrLnJlc3RvcmUoKTtcbiAgYm9ja2ZzLnJlc3RvcmUoKTtcbn0pO1xuXG5kZXNjcmliZSgnd2l0aCBkZWZhdWx0IGNvbmZpZyBmaWxlcycsICgpID0+IHtcbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgYm9ja2ZzKHtcbiAgICAgICcvaG9tZS9tZS8uYnh0L2NyZWRlbnRpYWxzJzogZGVkZW50KGBcbiAgICAgICAgW2RlZmF1bHRdXG4gICAgICAgIGF3c19hY2Nlc3Nfa2V5X2lkPSR7dWlkfWFjY2Vzc1xuICAgICAgICBhd3Nfc2VjcmV0X2FjY2Vzc19rZXk9c2VjcmV0XG5cbiAgICAgICAgW2Zvb11cbiAgICAgICAgYXdzX2FjY2Vzc19rZXlfaWQ9JHt1aWR9Zm9vY2Nlc3NcbiAgICAgICAgYXdzX3NlY3JldF9hY2Nlc3Nfa2V5PXNlY3JldFxuXG4gICAgICAgIFthc3N1bWVyXVxuICAgICAgICBhd3NfYWNjZXNzX2tleV9pZD0ke3VpZH1hc3N1bWVyXG4gICAgICAgIGF3c19zZWNyZXRfYWNjZXNzX2tleT1zZWNyZXRcblxuICAgICAgICBbbWZhXVxuICAgICAgICBhd3NfYWNjZXNzX2tleV9pZD0ke3VpZH1tZmFjY2Vzc1xuICAgICAgICBhd3Nfc2VjcmV0X2FjY2Vzc19rZXk9c2VjcmV0XG4gICAgICBgKSxcbiAgICAgICcvaG9tZS9tZS8uYnh0L2NvbmZpZyc6IGRlZGVudChgXG4gICAgICAgIFtkZWZhdWx0XVxuICAgICAgICByZWdpb249ZXUtYmxhLTVcblxuICAgICAgICBbcHJvZmlsZSBmb29dXG4gICAgICAgIHJlZ2lvbj1ldS13ZXN0LTFcblxuICAgICAgICBbcHJvZmlsZSBib29dXG4gICAgICAgIGF3c19hY2Nlc3Nfa2V5X2lkPSR7dWlkfWJvb2NjZXNzXG4gICAgICAgIGF3c19zZWNyZXRfYWNjZXNzX2tleT1ib29jcmV0XG4gICAgICAgICMgTm8gcmVnaW9uIGhlcmVcblxuICAgICAgICBbcHJvZmlsZSBhc3N1bWFibGVdXG4gICAgICAgIHJvbGVfYXJuPWFybjphd3M6aWFtOjoxMjM1Njc4OTAxMjpyb2xlL0Fzc3VtYWJsZVxuICAgICAgICBzb3VyY2VfcHJvZmlsZT1hc3N1bWVyXG5cbiAgICAgICAgW3Byb2ZpbGUgYXNzdW1lcl1cbiAgICAgICAgcmVnaW9uPXVzLWVhc3QtMlxuXG4gICAgICAgIFtwcm9maWxlIG1mYV1cbiAgICAgICAgcmVnaW9uPWV1LXdlc3QtMVxuXG4gICAgICAgIFtwcm9maWxlIG1mYS1yb2xlXVxuICAgICAgICBzb3VyY2VfcHJvZmlsZT1tZmFcbiAgICAgICAgcm9sZV9hcm49YXJuOmF3czppYW06OmFjY291bnQ6cm9sZS9yb2xlXG4gICAgICAgIG1mYV9zZXJpYWw9YXJuOmF3czppYW06OmFjY291bnQ6bWZhL3VzZXJcbiAgICAgIGApLFxuICAgIH0pO1xuXG4gICAgLy8gU2V0IGVudmlyb25tZW50IHZhcmlhYmxlcyB0aGF0IHdlIHdhbnRcbiAgICBwcm9jZXNzLmVudi5BV1NfQ09ORklHX0ZJTEUgPSBib2NrZnMucGF0aCgnL2hvbWUvbWUvLmJ4dC9jb25maWcnKTtcbiAgICBwcm9jZXNzLmVudi5BV1NfU0hBUkVEX0NSRURFTlRJQUxTX0ZJTEUgPSBib2NrZnMucGF0aCgnL2hvbWUvbWUvLmJ4dC9jcmVkZW50aWFscycpO1xuICB9KTtcblxuICBkZXNjcmliZSgnQ0xJIGNvbXBhdGlibGUgY3JlZGVudGlhbHMgbG9hZGluZycsICgpID0+IHtcbiAgICB0ZXN0KCdkZWZhdWx0IGNvbmZpZyBjcmVkZW50aWFscycsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIFdIRU5cbiAgICAgIGNvbnN0IHByb3ZpZGVyID0gYXdhaXQgU2RrUHJvdmlkZXIud2l0aEF3c0NsaUNvbXBhdGlibGVEZWZhdWx0cyh7IC4uLmRlZmF1bHRDcmVkT3B0aW9ucyB9KTtcblxuICAgICAgLy8gVEhFTlxuICAgICAgZXhwZWN0KHByb3ZpZGVyLmRlZmF1bHRSZWdpb24pLnRvRXF1YWwoJ2V1LWJsYS01Jyk7XG4gICAgICBhd2FpdCBleHBlY3QocHJvdmlkZXIuZGVmYXVsdEFjY291bnQoKSkucmVzb2x2ZXMudG9FcXVhbCh7IGFjY291bnRJZDogYCR7dWlkfXRoZV9hY2NvdW50XyNgLCBwYXJ0aXRpb246ICdhd3MtaGVyZScgfSk7XG4gICAgICBjb25zdCBzZGsgPSBhd2FpdCBwcm92aWRlci5mb3JFbnZpcm9ubWVudCh7IC4uLmRlZmF1bHRFbnYsIHJlZ2lvbjogJ3JnbicgfSwgTW9kZS5Gb3JSZWFkaW5nKTtcbiAgICAgIGV4cGVjdChzZGtDb25maWcoc2RrKS5jcmVkZW50aWFscyEuYWNjZXNzS2V5SWQpLnRvRXF1YWwoYCR7dWlkfWFjY2Vzc2ApO1xuICAgICAgZXhwZWN0KHNka0NvbmZpZyhzZGspLnJlZ2lvbikudG9FcXVhbCgncmduJyk7XG4gICAgfSk7XG5cbiAgICB0ZXN0KCd1bmtub3duIGFjY291bnQgYW5kIHJlZ2lvbiB1c2VzIGN1cnJlbnQnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBXSEVOXG4gICAgICBjb25zdCBwcm92aWRlciA9IGF3YWl0IFNka1Byb3ZpZGVyLndpdGhBd3NDbGlDb21wYXRpYmxlRGVmYXVsdHMoeyAuLi5kZWZhdWx0Q3JlZE9wdGlvbnMgfSk7XG5cbiAgICAgIC8vIFRIRU5cbiAgICAgIGNvbnN0IHNkayA9IGF3YWl0IHByb3ZpZGVyLmZvckVudmlyb25tZW50KGN4YXBpLkVudmlyb25tZW50VXRpbHMubWFrZShjeGFwaS5VTktOT1dOX0FDQ09VTlQsIGN4YXBpLlVOS05PV05fUkVHSU9OKSwgTW9kZS5Gb3JSZWFkaW5nKTtcbiAgICAgIGV4cGVjdChzZGtDb25maWcoc2RrKS5jcmVkZW50aWFscyEuYWNjZXNzS2V5SWQpLnRvRXF1YWwoYCR7dWlkfWFjY2Vzc2ApO1xuICAgICAgZXhwZWN0KHNka0NvbmZpZyhzZGspLnJlZ2lvbikudG9FcXVhbCgnZXUtYmxhLTUnKTtcbiAgICB9KTtcblxuICAgIHRlc3QoJ21peGVkIHByb2ZpbGUgY3JlZGVudGlhbHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBXSEVOXG4gICAgICBjb25zdCBwcm92aWRlciA9IGF3YWl0IFNka1Byb3ZpZGVyLndpdGhBd3NDbGlDb21wYXRpYmxlRGVmYXVsdHMoeyAuLi5kZWZhdWx0Q3JlZE9wdGlvbnMsIHByb2ZpbGU6ICdmb28nIH0pO1xuXG4gICAgICAvLyBUSEVOXG4gICAgICBleHBlY3QocHJvdmlkZXIuZGVmYXVsdFJlZ2lvbikudG9FcXVhbCgnZXUtd2VzdC0xJyk7XG4gICAgICBhd2FpdCBleHBlY3QocHJvdmlkZXIuZGVmYXVsdEFjY291bnQoKSkucmVzb2x2ZXMudG9FcXVhbCh7IGFjY291bnRJZDogYCR7dWlkfXRoZV9hY2NvdW50XyNgLCBwYXJ0aXRpb246ICdhd3MtaGVyZScgfSk7XG4gICAgICBjb25zdCBzZGsgPSBhd2FpdCBwcm92aWRlci5mb3JFbnZpcm9ubWVudChkZWZhdWx0RW52LCBNb2RlLkZvclJlYWRpbmcpO1xuICAgICAgZXhwZWN0KHNka0NvbmZpZyhzZGspLmNyZWRlbnRpYWxzIS5hY2Nlc3NLZXlJZCkudG9FcXVhbChgJHt1aWR9Zm9vY2Nlc3NgKTtcbiAgICB9KTtcblxuICAgIHRlc3QoJ3B1cmUgY29uZmlnIGNyZWRlbnRpYWxzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gV0hFTlxuICAgICAgY29uc3QgcHJvdmlkZXIgPSBhd2FpdCBTZGtQcm92aWRlci53aXRoQXdzQ2xpQ29tcGF0aWJsZURlZmF1bHRzKHsgLi4uZGVmYXVsdENyZWRPcHRpb25zLCBwcm9maWxlOiAnYm9vJyB9KTtcblxuICAgICAgLy8gVEhFTlxuICAgICAgZXhwZWN0KHByb3ZpZGVyLmRlZmF1bHRSZWdpb24pLnRvRXF1YWwoJ2V1LWJsYS01Jyk7IC8vIEZhbGwgYmFjayB0byBkZWZhdWx0IGNvbmZpZ1xuICAgICAgYXdhaXQgZXhwZWN0KHByb3ZpZGVyLmRlZmF1bHRBY2NvdW50KCkpLnJlc29sdmVzLnRvRXF1YWwoeyBhY2NvdW50SWQ6IGAke3VpZH10aGVfYWNjb3VudF8jYCwgcGFydGl0aW9uOiAnYXdzLWhlcmUnIH0pO1xuICAgICAgY29uc3Qgc2RrID0gYXdhaXQgcHJvdmlkZXIuZm9yRW52aXJvbm1lbnQoZGVmYXVsdEVudiwgTW9kZS5Gb3JSZWFkaW5nKTtcbiAgICAgIGV4cGVjdChzZGtDb25maWcoc2RrKS5jcmVkZW50aWFscyEuYWNjZXNzS2V5SWQpLnRvRXF1YWwoYCR7dWlkfWJvb2NjZXNzYCk7XG4gICAgfSk7XG5cbiAgICB0ZXN0KCdtZmFfc2VyaWFsIGluIHByb2ZpbGUgd2lsbCBhc2sgdXNlciBmb3IgdG9rZW4nLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBXSEVOXG4gICAgICBjb25zdCBwcm92aWRlciA9IGF3YWl0IFNka1Byb3ZpZGVyLndpdGhBd3NDbGlDb21wYXRpYmxlRGVmYXVsdHMoeyAuLi5kZWZhdWx0Q3JlZE9wdGlvbnMsIHByb2ZpbGU6ICdtZmEtcm9sZScgfSk7XG5cbiAgICAgIC8vIFRIRU5cbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHByb3ZpZGVyLndpdGhBc3N1bWVkUm9sZSgnYXJuOmF3czppYW06OmFjY291bnQ6cm9sZS9yb2xlJywgdW5kZWZpbmVkLCB1bmRlZmluZWQpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAvLyBNb2NrIHJlc3BvbnNlIHdhcyBzZXQgdG8gZmFpbCB3aXRoIG1lc3NhZ2UgdGVzdCB0byBtYWtlIHN1cmUgd2UgZG9uJ3QgY2FsbCBTVFNcbiAgICAgICAgZXhwZWN0KGUubWVzc2FnZSkudG9FcXVhbCgnRXJyb3IgZmV0Y2hpbmcgTUZBIHRva2VuOiB0ZXN0Jyk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICB0ZXN0KCdkaWZmZXJlbnQgYWNjb3VudCB0aHJvd3MnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBwcm92aWRlciA9IGF3YWl0IFNka1Byb3ZpZGVyLndpdGhBd3NDbGlDb21wYXRpYmxlRGVmYXVsdHMoeyAuLi5kZWZhdWx0Q3JlZE9wdGlvbnMsIHByb2ZpbGU6ICdib28nIH0pO1xuXG4gICAgICBhd2FpdCBleHBlY3QocHJvdmlkZXIuZm9yRW52aXJvbm1lbnQoeyAuLi5kZWZhdWx0RW52LCBhY2NvdW50OiBgJHt1aWR9c29tZV9hY2NvdW50XyNgIH0sIE1vZGUuRm9yUmVhZGluZykpLnJlamVjdHMudG9UaHJvdygnTmVlZCB0byBwZXJmb3JtIEFXUyBjYWxscycpO1xuICAgIH0pO1xuXG4gICAgdGVzdCgnZXZlbiB3aGVuIHVzaW5nIGEgcHJvZmlsZSB0byBhc3N1bWUgYW5vdGhlciBwcm9maWxlLCBTVFMgY2FsbHMgZ29lcyB0aHJvdWdoIHRoZSBwcm94eScsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIE1lc3N5IG1vY2tpbmdcbiAgICAgIGxldCBjYWxsZWQgPSBmYWxzZTtcbiAgICAgIGplc3QubW9jaygncHJveHktYWdlbnQnLCAoKSA9PiB7XG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tcmVxdWlyZS1pbXBvcnRzXG4gICAgICAgIGNsYXNzIEZha2VBZ2VudCBleHRlbmRzIHJlcXVpcmUoJ2h0dHBzJykuQWdlbnQge1xuICAgICAgICAgIHB1YmxpYyBhZGRSZXF1ZXN0KF86IGFueSwgX186IGFueSkge1xuICAgICAgICAgICAgLy8gRklYTUU6IHRoaXMgZXJyb3IgdGFrZXMgNiBzZWNvbmRzIHRvIGJlIGNvbXBsZXRlbHkgaGFuZGxlZC4gSXRcbiAgICAgICAgICAgIC8vIG1pZ2h0IGJlIHJldHJpZXMgaW4gdGhlIFNESyBzb21ld2hlcmUsIG9yIHNvbWV0aGluZyBhYm91dCB0aGUgTm9kZVxuICAgICAgICAgICAgLy8gZXZlbnQgbG9vcC4gSSd2ZSBzcGVudCBhbiBob3VyIHRyeWluZyB0byBmaWd1cmUgaXQgb3V0IGFuZCBJIGNhbid0LFxuICAgICAgICAgICAgLy8gYW5kIEkgZ2F2ZSB1cC4gV2UnbGwganVzdCBoYXZlIHRvIGxpdmUgd2l0aCB0aGlzIHVudGlsIHNvbWVvbmUgZ2V0c1xuICAgICAgICAgICAgLy8gaW5zcGlyZWQuXG4gICAgICAgICAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcignQUJPUlRFRCBCWSBURVNUJyk7XG4gICAgICAgICAgICAoZXJyb3IgYXMgYW55KS5jb2RlID0gJ1JlcXVlc3RBYm9ydGVkRXJyb3InO1xuICAgICAgICAgICAgKGVycm9yIGFzIGFueSkucmV0cnlhYmxlID0gZmFsc2U7XG4gICAgICAgICAgICBjYWxsZWQgPSB0cnVlO1xuICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBGYWtlQWdlbnQ7XG4gICAgICB9KTtcblxuICAgICAgLy8gV0hFTlxuICAgICAgY29uc3QgcHJvdmlkZXIgPSBhd2FpdCBTZGtQcm92aWRlci53aXRoQXdzQ2xpQ29tcGF0aWJsZURlZmF1bHRzKHtcbiAgICAgICAgLi4uZGVmYXVsdENyZWRPcHRpb25zLFxuICAgICAgICBwcm9maWxlOiAnYXNzdW1hYmxlJyxcbiAgICAgICAgaHR0cE9wdGlvbnM6IHtcbiAgICAgICAgICBwcm94eUFkZHJlc3M6ICdodHRwOi8vRE9FU05UTUFUVEVSLycsXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgYXdhaXQgcHJvdmlkZXIuZGVmYXVsdEFjY291bnQoKTtcblxuICAgICAgLy8gVEhFTiAtLSB0aGUgZmFrZSBwcm94eSBhZ2VudCBnb3QgY2FsbGVkLCB3ZSBkb24ndCBjYXJlIGFib3V0IHRoZSByZXN1bHRcbiAgICAgIGV4cGVjdChjYWxsZWQpLnRvRXF1YWwodHJ1ZSk7XG4gICAgfSk7XG5cbiAgICB0ZXN0KCdlcnJvciB3ZSBnZXQgZnJvbSBhc3N1bWluZyBhIHJvbGUgaXMgdXNlZnVsJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gR0lWRU5cbiAgICAgIC8vIEJlY2F1c2Ugb2YgdGhlIHdheSBDaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFscyBnZXRzIGl0cyBTVFMgY2xpZW50LCBpdCdzIG5vdCBtb2NrYWJsZVxuICAgICAgLy8gdXNpbmcgJ21vY2stYXdzLXNkaycuIFNvIGluc3RlYWQsIHdlIGhhdmUgdG8gbWVzcyBhcm91bmQgd2l0aCBpdHMgaW50ZXJuYWxzLlxuICAgICAgZnVuY3Rpb24gbWFrZUFzc3VtZVJvbGVGYWlsKHM6IElTREspIHtcbiAgICAgICAgKHMgYXMgYW55KS5jcmVkZW50aWFscy5zZXJ2aWNlLmFzc3VtZVJvbGUgPSBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKChfcmVxdWVzdCwgY2IpID0+IHtcbiAgICAgICAgICBjYihuZXcgRXJyb3IoJ05vcGUhJykpO1xuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgcHJvdmlkZXIgPSBhd2FpdCBTZGtQcm92aWRlci53aXRoQXdzQ2xpQ29tcGF0aWJsZURlZmF1bHRzKHtcbiAgICAgICAgLi4uZGVmYXVsdENyZWRPcHRpb25zLFxuICAgICAgICBodHRwT3B0aW9uczoge1xuICAgICAgICAgIHByb3h5QWRkcmVzczogJ2h0dHA6Ly9sb2NhbGhvc3Q6ODA4MC8nLFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIC8vIFdIRU5cbiAgICAgIGNvbnN0IHNkayA9IGF3YWl0IHByb3ZpZGVyLndpdGhBc3N1bWVkUm9sZSgnYmxhLnJvbGUuYXJuJywgdW5kZWZpbmVkLCB1bmRlZmluZWQpO1xuICAgICAgbWFrZUFzc3VtZVJvbGVGYWlsKHNkayk7XG5cbiAgICAgIC8vIFRIRU4gLSBlcnJvciBtZXNzYWdlIGNvbnRhaW5zIGJvdGggYSBoZWxwZnVsIGhpbnQgYW5kIHRoZSB1bmRlcmx5aW5nIEFzc3VtZVJvbGUgbWVzc2FnZVxuICAgICAgYXdhaXQgZXhwZWN0KHNkay5zMygpLmxpc3RCdWNrZXRzKCkucHJvbWlzZSgpKS5yZWplY3RzLnRvVGhyb3coJ2RpZCB5b3UgYm9vdHN0cmFwJyk7XG4gICAgICBhd2FpdCBleHBlY3Qoc2RrLnMzKCkubGlzdEJ1Y2tldHMoKS5wcm9taXNlKCkpLnJlamVjdHMudG9UaHJvdygnTm9wZSEnKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ1BsdWdpbnMnLCAoKSA9PiB7XG4gICAgdGVzdCgnZG9lcyBub3QgdXNlIHBsdWdpbnMgaWYgY3VycmVudCBjcmVkZW50aWFscyBhcmUgZm9yIGV4cGVjdGVkIGFjY291bnQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBwcm92aWRlciA9IGF3YWl0IFNka1Byb3ZpZGVyLndpdGhBd3NDbGlDb21wYXRpYmxlRGVmYXVsdHMoeyAuLi5kZWZhdWx0Q3JlZE9wdGlvbnMgfSk7XG4gICAgICBhd2FpdCBwcm92aWRlci5mb3JFbnZpcm9ubWVudChkZWZhdWx0RW52LCBNb2RlLkZvclJlYWRpbmcpO1xuICAgICAgZXhwZWN0KHBsdWdpblF1ZXJpZWQpLnRvRXF1YWwoZmFsc2UpO1xuICAgIH0pO1xuXG4gICAgdGVzdCgndXNlcyBwbHVnaW4gZm9yIG90aGVyIGFjY291bnQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBwcm92aWRlciA9IGF3YWl0IFNka1Byb3ZpZGVyLndpdGhBd3NDbGlDb21wYXRpYmxlRGVmYXVsdHMoeyAuLi5kZWZhdWx0Q3JlZE9wdGlvbnMgfSk7XG4gICAgICBhd2FpdCBwcm92aWRlci5mb3JFbnZpcm9ubWVudCh7IC4uLmRlZmF1bHRFbnYsIGFjY291bnQ6IGAke3VpZH1wbHVnaW5fYWNjb3VudF8jYCB9LCBNb2RlLkZvclJlYWRpbmcpO1xuICAgICAgZXhwZWN0KHBsdWdpblF1ZXJpZWQpLnRvRXF1YWwodHJ1ZSk7XG4gICAgfSk7XG4gIH0pO1xufSk7XG5cbnRlc3QoJ2NhbiBhc3N1bWUgcm9sZSB3aXRob3V0IGEgW2RlZmF1bHRdIHByb2ZpbGUnLCBhc3luYyAoKSA9PiB7XG4gIC8vIEdJVkVOXG4gIGJvY2tmcyh7XG4gICAgJy9ob21lL21lLy5ieHQvY3JlZGVudGlhbHMnOiBkZWRlbnQoYFxuICAgICAgW2Fzc3VtZXJdXG4gICAgICBhd3NfYWNjZXNzX2tleV9pZD0ke3VpZH1hc3N1bWVyXG4gICAgICBhd3Nfc2VjcmV0X2FjY2Vzc19rZXk9c2VjcmV0XG5cbiAgICAgIFthc3N1bWFibGVdXG4gICAgICByb2xlX2Fybj1hcm46YXdzOmlhbTo6MTIzNTY3ODkwMTI6cm9sZS9Bc3N1bWFibGVcbiAgICAgIHNvdXJjZV9wcm9maWxlPWFzc3VtZXJcbiAgICBgKSxcbiAgICAnL2hvbWUvbWUvLmJ4dC9jb25maWcnOiBkZWRlbnQoYFxuICAgICAgW3Byb2ZpbGUgYXNzdW1hYmxlXVxuICAgICAgcmVnaW9uPWV1LWJsYS01XG4gICAgYCksXG4gIH0pO1xuXG4gIFNES01vY2subW9jaygnU1RTJywgJ2Fzc3VtZVJvbGUnLCAoX3JlcXVlc3Q6IEFXUy5TVFMuQXNzdW1lUm9sZVJlcXVlc3QsIGNiOiBBd3NDYWxsYmFjazxBV1MuU1RTLkFzc3VtZVJvbGVSZXNwb25zZT4pID0+IHtcbiAgICByZXR1cm4gY2IobnVsbCwge1xuICAgICAgQ3JlZGVudGlhbHM6IHtcbiAgICAgICAgQWNjZXNzS2V5SWQ6IGAke3VpZH1hY2Nlc3NgLCAvLyBOZWVkcyBVSUQgaW4gaGVyZSBvdGhlcndpc2Uga2V5IHdpbGwgYmUgY2FjaGVkXG4gICAgICAgIEV4cGlyYXRpb246IG5ldyBEYXRlKERhdGUubm93KCkgKyAxMDAwMCksXG4gICAgICAgIFNlY3JldEFjY2Vzc0tleTogJ2InLFxuICAgICAgICBTZXNzaW9uVG9rZW46ICdjJyxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH0pO1xuXG4gIC8vIFNldCBlbnZpcm9ubWVudCB2YXJpYWJsZXMgdGhhdCB3ZSB3YW50XG4gIHByb2Nlc3MuZW52LkFXU19DT05GSUdfRklMRSA9IGJvY2tmcy5wYXRoKCcvaG9tZS9tZS8uYnh0L2NvbmZpZycpO1xuICBwcm9jZXNzLmVudi5BV1NfU0hBUkVEX0NSRURFTlRJQUxTX0ZJTEUgPSBib2NrZnMucGF0aCgnL2hvbWUvbWUvLmJ4dC9jcmVkZW50aWFscycpO1xuXG4gIC8vIFdIRU5cbiAgY29uc3QgcHJvdmlkZXIgPSBhd2FpdCBTZGtQcm92aWRlci53aXRoQXdzQ2xpQ29tcGF0aWJsZURlZmF1bHRzKHtcbiAgICAuLi5kZWZhdWx0Q3JlZE9wdGlvbnMsXG4gICAgcHJvZmlsZTogJ2Fzc3VtYWJsZScsXG4gICAgaHR0cE9wdGlvbnM6IHtcbiAgICAgIHByb3h5QWRkcmVzczogJ2h0dHA6Ly9ET0VTTlRNQVRURVIvJyxcbiAgICB9LFxuICB9KTtcblxuICBjb25zdCBhY2NvdW50ID0gYXdhaXQgcHJvdmlkZXIuZGVmYXVsdEFjY291bnQoKTtcblxuICAvLyBUSEVOXG4gIGV4cGVjdChhY2NvdW50Py5hY2NvdW50SWQpLnRvRXF1YWwoYCR7dWlkfXRoZV9hY2NvdW50XyNgKTtcbn0pO1xuXG50ZXN0KCdjYW4gYXNzdW1lIHJvbGUgd2l0aCBlY3MgY3JlZGVudGlhbHMnLCBhc3luYyAoKSA9PiB7XG5cbiAgcmV0dXJuIHdpdGhNb2NrZWQoQVdTLkVDU0NyZWRlbnRpYWxzLnByb3RvdHlwZSwgJ25lZWRzUmVmcmVzaCcsIGFzeW5jIChuZWVkc1JlZnJlc2gpID0+IHtcblxuICAgIC8vIEdJVkVOXG4gICAgYm9ja2ZzKHtcbiAgICAgICcvaG9tZS9tZS8uYnh0L2NyZWRlbnRpYWxzJzogZGVkZW50KGBcbiAgICBgKSxcbiAgICAgICcvaG9tZS9tZS8uYnh0L2NvbmZpZyc6IGRlZGVudChgXG4gICAgICBbcHJvZmlsZSBlY3NdXG4gICAgICByb2xlX2Fybj1hcm46YXdzOmlhbTo6MTIzNTY3ODkwMTI6cm9sZS9Bc3N1bWFibGVcbiAgICAgIGNyZWRlbnRpYWxfc291cmNlID0gRWNzQ29udGFpbmVyXG4gICAgYCksXG4gICAgfSk7XG5cbiAgICAvLyBTZXQgZW52aXJvbm1lbnQgdmFyaWFibGVzIHRoYXQgd2Ugd2FudFxuICAgIHByb2Nlc3MuZW52LkFXU19DT05GSUdfRklMRSA9IGJvY2tmcy5wYXRoKCcvaG9tZS9tZS8uYnh0L2NvbmZpZycpO1xuICAgIHByb2Nlc3MuZW52LkFXU19TSEFSRURfQ1JFREVOVElBTFNfRklMRSA9IGJvY2tmcy5wYXRoKCcvaG9tZS9tZS8uYnh0L2NyZWRlbnRpYWxzJyk7XG5cbiAgICAvLyBXSEVOXG4gICAgY29uc3QgcHJvdmlkZXIgPSBhd2FpdCBTZGtQcm92aWRlci53aXRoQXdzQ2xpQ29tcGF0aWJsZURlZmF1bHRzKHtcbiAgICAgIC4uLmRlZmF1bHRDcmVkT3B0aW9ucyxcbiAgICAgIHByb2ZpbGU6ICdlY3MnLFxuICAgICAgaHR0cE9wdGlvbnM6IHtcbiAgICAgICAgcHJveHlBZGRyZXNzOiAnaHR0cDovL0RPRVNOVE1BVFRFUi8nLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIGF3YWl0IHByb3ZpZGVyLmRlZmF1bHRBY2NvdW50KCk7XG5cbiAgICAvLyBUSEVOXG4gICAgLy8gZXhwZWN0KGFjY291bnQ/LmFjY291bnRJZCkudG9FcXVhbChgJHt1aWR9dGhlX2FjY291bnRfI2ApO1xuICAgIGV4cGVjdChuZWVkc1JlZnJlc2gpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcblxuICB9KTtcblxufSk7XG5cbnRlc3QoJ2NhbiBhc3N1bWUgcm9sZSB3aXRoIGVjMiBjcmVkZW50aWFscycsIGFzeW5jICgpID0+IHtcblxuICByZXR1cm4gd2l0aE1vY2tlZChBV1MuRUMyTWV0YWRhdGFDcmVkZW50aWFscy5wcm90b3R5cGUsICduZWVkc1JlZnJlc2gnLCBhc3luYyAobmVlZHNSZWZyZXNoKSA9PiB7XG5cbiAgICAvLyBHSVZFTlxuICAgIGJvY2tmcyh7XG4gICAgICAnL2hvbWUvbWUvLmJ4dC9jcmVkZW50aWFscyc6IGRlZGVudChgXG4gICAgYCksXG4gICAgICAnL2hvbWUvbWUvLmJ4dC9jb25maWcnOiBkZWRlbnQoYFxuICAgICAgW3Byb2ZpbGUgZWNzXVxuICAgICAgcm9sZV9hcm49YXJuOmF3czppYW06OjEyMzU2Nzg5MDEyOnJvbGUvQXNzdW1hYmxlXG4gICAgICBjcmVkZW50aWFsX3NvdXJjZSA9IEVjMkluc3RhbmNlTWV0YWRhdGFcbiAgICBgKSxcbiAgICB9KTtcblxuICAgIC8vIFNldCBlbnZpcm9ubWVudCB2YXJpYWJsZXMgdGhhdCB3ZSB3YW50XG4gICAgcHJvY2Vzcy5lbnYuQVdTX0NPTkZJR19GSUxFID0gYm9ja2ZzLnBhdGgoJy9ob21lL21lLy5ieHQvY29uZmlnJyk7XG4gICAgcHJvY2Vzcy5lbnYuQVdTX1NIQVJFRF9DUkVERU5USUFMU19GSUxFID0gYm9ja2ZzLnBhdGgoJy9ob21lL21lLy5ieHQvY3JlZGVudGlhbHMnKTtcblxuICAgIC8vIFdIRU5cbiAgICBjb25zdCBwcm92aWRlciA9IGF3YWl0IFNka1Byb3ZpZGVyLndpdGhBd3NDbGlDb21wYXRpYmxlRGVmYXVsdHMoe1xuICAgICAgLi4uZGVmYXVsdENyZWRPcHRpb25zLFxuICAgICAgcHJvZmlsZTogJ2VjcycsXG4gICAgICBodHRwT3B0aW9uczoge1xuICAgICAgICBwcm94eUFkZHJlc3M6ICdodHRwOi8vRE9FU05UTUFUVEVSLycsXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgYXdhaXQgcHJvdmlkZXIuZGVmYXVsdEFjY291bnQoKTtcblxuICAgIC8vIFRIRU5cbiAgICAvLyBleHBlY3QoYWNjb3VudD8uYWNjb3VudElkKS50b0VxdWFsKGAke3VpZH10aGVfYWNjb3VudF8jYCk7XG4gICAgZXhwZWN0KG5lZWRzUmVmcmVzaCkudG9IYXZlQmVlbkNhbGxlZCgpO1xuXG4gIH0pO1xuXG59KTtcblxudGVzdCgnY2FuIGFzc3VtZSByb2xlIHdpdGggZW52IGNyZWRlbnRpYWxzJywgYXN5bmMgKCkgPT4ge1xuXG4gIHJldHVybiB3aXRoTW9ja2VkKEFXUy5FbnZpcm9ubWVudENyZWRlbnRpYWxzLnByb3RvdHlwZSwgJ25lZWRzUmVmcmVzaCcsIGFzeW5jIChuZWVkc1JlZnJlc2gpID0+IHtcblxuICAgIC8vIEdJVkVOXG4gICAgYm9ja2ZzKHtcbiAgICAgICcvaG9tZS9tZS8uYnh0L2NyZWRlbnRpYWxzJzogZGVkZW50KGBcbiAgICBgKSxcbiAgICAgICcvaG9tZS9tZS8uYnh0L2NvbmZpZyc6IGRlZGVudChgXG4gICAgICBbcHJvZmlsZSBlY3NdXG4gICAgICByb2xlX2Fybj1hcm46YXdzOmlhbTo6MTIzNTY3ODkwMTI6cm9sZS9Bc3N1bWFibGVcbiAgICAgIGNyZWRlbnRpYWxfc291cmNlID0gRW52aXJvbm1lbnRcbiAgICBgKSxcbiAgICB9KTtcblxuICAgIC8vIFNldCBlbnZpcm9ubWVudCB2YXJpYWJsZXMgdGhhdCB3ZSB3YW50XG4gICAgcHJvY2Vzcy5lbnYuQVdTX0NPTkZJR19GSUxFID0gYm9ja2ZzLnBhdGgoJy9ob21lL21lLy5ieHQvY29uZmlnJyk7XG4gICAgcHJvY2Vzcy5lbnYuQVdTX1NIQVJFRF9DUkVERU5USUFMU19GSUxFID0gYm9ja2ZzLnBhdGgoJy9ob21lL21lLy5ieHQvY3JlZGVudGlhbHMnKTtcblxuICAgIC8vIFdIRU5cbiAgICBjb25zdCBwcm92aWRlciA9IGF3YWl0IFNka1Byb3ZpZGVyLndpdGhBd3NDbGlDb21wYXRpYmxlRGVmYXVsdHMoe1xuICAgICAgLi4uZGVmYXVsdENyZWRPcHRpb25zLFxuICAgICAgcHJvZmlsZTogJ2VjcycsXG4gICAgICBodHRwT3B0aW9uczoge1xuICAgICAgICBwcm94eUFkZHJlc3M6ICdodHRwOi8vRE9FU05UTUFUVEVSLycsXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgYXdhaXQgcHJvdmlkZXIuZGVmYXVsdEFjY291bnQoKTtcblxuICAgIC8vIFRIRU5cbiAgICAvLyBleHBlY3QoYWNjb3VudD8uYWNjb3VudElkKS50b0VxdWFsKGAke3VpZH10aGVfYWNjb3VudF8jYCk7XG4gICAgZXhwZWN0KG5lZWRzUmVmcmVzaCkudG9IYXZlQmVlbkNhbGxlZCgpO1xuXG4gIH0pO1xuXG59KTtcblxudGVzdCgnYXNzdW1lIGZhaWxzIHdpdGggdW5zdXBwb3J0ZWQgY3JlZGVudGlhbF9zb3VyY2UnLCBhc3luYyAoKSA9PiB7XG4gIC8vIEdJVkVOXG4gIGJvY2tmcyh7XG4gICAgJy9ob21lL21lLy5ieHQvY29uZmlnJzogZGVkZW50KGBcbiAgICAgIFtwcm9maWxlIGFzc3VtYWJsZV1cbiAgICAgIHJvbGVfYXJuPWFybjphd3M6aWFtOjoxMjM1Njc4OTAxMjpyb2xlL0Fzc3VtYWJsZVxuICAgICAgY3JlZGVudGlhbF9zb3VyY2UgPSB1bnN1cHBvcnRlZFxuICAgIGApLFxuICB9KTtcblxuICBTREtNb2NrLm1vY2soJ1NUUycsICdhc3N1bWVSb2xlJywgKF9yZXF1ZXN0OiBBV1MuU1RTLkFzc3VtZVJvbGVSZXF1ZXN0LCBjYjogQXdzQ2FsbGJhY2s8QVdTLlNUUy5Bc3N1bWVSb2xlUmVzcG9uc2U+KSA9PiB7XG4gICAgcmV0dXJuIGNiKG51bGwsIHtcbiAgICAgIENyZWRlbnRpYWxzOiB7XG4gICAgICAgIEFjY2Vzc0tleUlkOiBgJHt1aWR9YWNjZXNzYCwgLy8gTmVlZHMgVUlEIGluIGhlcmUgb3RoZXJ3aXNlIGtleSB3aWxsIGJlIGNhY2hlZFxuICAgICAgICBFeHBpcmF0aW9uOiBuZXcgRGF0ZShEYXRlLm5vdygpICsgMTAwMDApLFxuICAgICAgICBTZWNyZXRBY2Nlc3NLZXk6ICdiJyxcbiAgICAgICAgU2Vzc2lvblRva2VuOiAnYycsXG4gICAgICB9LFxuICAgIH0pO1xuICB9KTtcblxuICAvLyBTZXQgZW52aXJvbm1lbnQgdmFyaWFibGVzIHRoYXQgd2Ugd2FudFxuICBwcm9jZXNzLmVudi5BV1NfQ09ORklHX0ZJTEUgPSBib2NrZnMucGF0aCgnL2hvbWUvbWUvLmJ4dC9jb25maWcnKTtcbiAgcHJvY2Vzcy5lbnYuQVdTX1NIQVJFRF9DUkVERU5USUFMU19GSUxFID0gYm9ja2ZzLnBhdGgoJy9ob21lL21lLy5ieHQvY3JlZGVudGlhbHMnKTtcblxuICAvLyBXSEVOXG4gIGNvbnN0IHByb3ZpZGVyID0gYXdhaXQgU2RrUHJvdmlkZXIud2l0aEF3c0NsaUNvbXBhdGlibGVEZWZhdWx0cyh7XG4gICAgLi4uZGVmYXVsdENyZWRPcHRpb25zLFxuICAgIHByb2ZpbGU6ICdhc3N1bWFibGUnLFxuICAgIGh0dHBPcHRpb25zOiB7XG4gICAgICBwcm94eUFkZHJlc3M6ICdodHRwOi8vRE9FU05UTUFUVEVSLycsXG4gICAgfSxcbiAgfSk7XG5cbiAgY29uc3QgYWNjb3VudCA9IGF3YWl0IHByb3ZpZGVyLmRlZmF1bHRBY2NvdW50KCk7XG5cbiAgLy8gVEhFTlxuICBleHBlY3QoYWNjb3VudD8uYWNjb3VudElkKS50b0VxdWFsKHVuZGVmaW5lZCk7XG59KTtcblxuLyoqXG4gKiBTdHJpcCBzaGFyZWQgd2hpdGVzcGFjZSBmcm9tIHRoZSBzdGFydCBvZiBsaW5lc1xuICovXG5mdW5jdGlvbiBkZWRlbnQoeDogc3RyaW5nKTogc3RyaW5nIHtcbiAgY29uc3QgbGluZXMgPSB4LnNwbGl0KCdcXG4nKTtcbiAgd2hpbGUgKGxpbmVzLmxlbmd0aCA+IDAgJiYgbGluZXNbMF0udHJpbSgpID09PSAnJykgeyBsaW5lcy5zaGlmdCgpOyB9XG4gIHdoaWxlIChsaW5lcy5sZW5ndGggPiAwICYmIGxpbmVzW2xpbmVzLmxlbmd0aCAtIDFdLnRyaW0oKSA9PT0gJycpIHsgbGluZXMucG9wKCk7IH1cblxuICBjb25zdCB3c1JlID0gL15cXHMqLztcbiAgY29uc3QgbGluZVBhcnRzOiBBcnJheTxbc3RyaW5nLCBzdHJpbmddPiA9IHguc3BsaXQoJ1xcbicpLm1hcChzID0+IHtcbiAgICBjb25zdCB3cyA9IHdzUmUuZXhlYyhzKSFbMF07XG4gICAgcmV0dXJuIFt3cywgcy5zdWJzdHIod3MubGVuZ3RoKV07XG4gIH0pO1xuXG4gIGlmIChsaW5lUGFydHMubGVuZ3RoID09PSAwKSB7IHJldHVybiAnJzsgfSAvLyBSZWR1Y2Ugd29uJ3Qgd29yayB3ZWxsIGluIHRoaXMgY2FzZVxuXG4gIC8vIENhbGN1bGF0ZSBjb21tb24gd2hpdGVzcGFjZSBvbmx5IGZvciBub24tZW1wdHkgbGluZXNcbiAgY29uc3Qgc2hhcmVkV3MgPSBsaW5lUGFydHMucmVkdWNlKChjb21tb25Xczogc3RyaW5nLCBbd3MsIHRleHRdKSA9PiB0ZXh0ICE9PSAnJyA/IGNvbW1vblByZWZpeChjb21tb25Xcywgd3MpIDogY29tbW9uV3MsIGxpbmVQYXJ0c1swXVswXSk7XG4gIHJldHVybiBsaW5lcy5tYXAocyA9PiBzLnN1YnN0cihzaGFyZWRXcy5sZW5ndGgpKS5qb2luKCdcXG4nKTtcbn1cblxuLyoqXG4gKiBVc2Ugb2JqZWN0IGhhY2tlcnkgdG8gZ2V0IHRoZSBjcmVkZW50aWFscyBvdXQgb2YgdGhlIFNESyBvYmplY3RcbiAqL1xuZnVuY3Rpb24gc2RrQ29uZmlnKHNkazogSVNESyk6IENvbmZpZ3VyYXRpb25PcHRpb25zIHtcbiAgcmV0dXJuIChzZGsgYXMgYW55KS5jb25maWc7XG59XG5cbmZ1bmN0aW9uIGNvbW1vblByZWZpeChhOiBzdHJpbmcsIGI6IHN0cmluZyk6IHN0cmluZyB7XG4gIGNvbnN0IE4gPSBNYXRoLm1pbihhLmxlbmd0aCwgYi5sZW5ndGgpO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IE47IGkrKykge1xuICAgIGlmIChhW2ldICE9PSBiW2ldKSB7IHJldHVybiBhLnN1YnN0cmluZygwLCBpKTsgfVxuICB9XG4gIHJldHVybiBhLnN1YnN0cihOKTtcbn1cbiJdfQ==